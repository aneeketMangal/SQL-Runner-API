/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package assignment_1;

import java.lang.reflect.Field;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import assignment_1.exceptions.CannotConnectToDatabaseException;
import assignment_1.exceptions.MultipleResultsFoundException;
import assignment_1.interfaces.SqlRunner;
import assignment_1.model.QueryObject;
import assignment_1.service.XMLParser;
import assignment_1.service.StringUtility.StringUtility;

public class Library implements SqlRunner {

    public Connection connection;
    public String xmlFilePath;
    public XMLParser xmlParser;
    public StringUtility stringUtility;
    public Statement statement;

    // Constructor for library Object
    public Library(Connection connection, String filePath) {
        this.connection = connection;
        this.xmlFilePath = filePath;
        this.xmlParser = new XMLParser(this.xmlFilePath);
        this.stringUtility = new StringUtility();
        try{
            this.statement = this.connection.createStatement();
        }
        catch(Exception E){
            throw new CannotConnectToDatabaseException(E);
        }
    }

    public <T> String getPopulatedQuery(String queryId, T queryParam){
        QueryObject queryObject = this.xmlParser.getQueryObject(queryId);
        return stringUtility.populateQuery(queryObject, queryParam);
    }


    public <T> int runCountQuery(String queryId, T queryParam) {
        String populatedQuery = getPopulatedQuery(queryId, queryParam);
        try {
            return statement.executeUpdate(populatedQuery);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public <T> ResultSet runSelectQuery(String queryId, T queryParam) {
        String populatedQuery = getPopulatedQuery(queryId, queryParam);
        try {
            return statement.executeQuery(populatedQuery);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public <R> R fillPOJO(ResultSet resultSet, ResultSetMetaData resultMeta, Class<R> resultType) {
        R returnPOJO;
        try {
            returnPOJO = resultType.getDeclaredConstructor().newInstance();
            for (int i = 0; i < resultMeta.getColumnCount(); i++) {
                Object value = resultSet.getObject(i + 1);
                Field field = resultType.getDeclaredField(resultMeta.getColumnName(i + 1)); // get the field
                field.set(returnPOJO, value);
            }
            return returnPOJO;
        } catch (Exception e){
            throw new RuntimeException(e);
        }
    }

    @Override
    public <T, R> R selectOne(String queryId, T queryParam, Class<R> resultType) {
        ResultSet resultSet = this.runSelectQuery(queryId, queryParam);
        try {
            ResultSetMetaData resultMeta = resultSet.getMetaData();
            if (resultSet.next()) {
                R returnPOJO = fillPOJO(resultSet, resultMeta, resultType);
                // in case more than one result is found
                if (resultSet.next()) {
                    throw (new MultipleResultsFoundException(queryId));
                } else {
                    return returnPOJO;
                 }
            } else {
                return null;
            }

        }
        catch(MultipleResultsFoundException E){
            throw E;
        }
        catch (Exception e) {
            throw new RuntimeException(e);
        }

    }

    @Override
    public <T, R> List<R> selectMany(String queryId, T queryParam, Class<R> resultType) {
        ResultSet resultSet = this.runSelectQuery(queryId, queryParam);
        try {
            ResultSetMetaData resultMeta = resultSet.getMetaData();
            List<R> parsedOutput = new ArrayList<R>();
            while (resultSet.next()) {
                R tempPOJO = fillPOJO(resultSet, resultMeta, resultType);
                parsedOutput.add(tempPOJO);
            }
            return parsedOutput;
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public <T> int insert(String queryId, T queryParam) {return this.runCountQuery(queryId, queryParam);}

    @Override
    public <T> int delete(String queryId, T queryParam) {return this.runCountQuery(queryId, queryParam);}

    @Override
    public <T> int update(String queryId, T queryParam) {return this.runCountQuery(queryId, queryParam);}
}
